<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detrending single images • detrendr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Detrending single images">
<meta property="og:description" content="detrendr">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">detrendr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.6.15</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/batch-mode.html">Batch mode</a>
    </li>
    <li>
      <a href="../articles/linescan-data.html">Linescan data</a>
    </li>
    <li>
      <a href="../articles/single-images.html">Detrending single images</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rorynolan/detrendr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="single-images_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Detrending single images</h1>
                        <h4 data-toc-skip class="author">Rory Nolan</h4>
            
            <h4 data-toc-skip class="date">2023-01-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rorynolan/detrendr/blob/HEAD/vignettes/single-images.Rmd" class="external-link"><code>vignettes/single-images.Rmd</code></a></small>
      <div class="hidden name"><code>single-images.Rmd</code></div>

    </div>

    
    
<p>In this vignette, we will look at detrending single images interactively in an R session.</p>
<p>First let’s load <code>detrendr</code> and <code>ijtiff</code>, which is for reading TIFF files:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html" class="external-link">p_load</a></span><span class="op">(</span><span class="va">detrendr</span>, <span class="va">ijtiff</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="an-image-in-need-of-detrending">An image in need of detrending<a class="anchor" aria-label="anchor" href="#an-image-in-need-of-detrending"></a>
</h2>
<p>The package contains a sample image series which can be found at<br><code>system.file("extdata", "2ch100frame.tif", package = "detrendr")</code>. It’s 2 channels each with 100 frames. Diffusing fluorescent particles are imaged. Protein A is labelled with a red dye and red photons are collected in channel 1. Protein B is labelled in green and green photons are collected in channel 2.</p>
<p>The image can be read into R with the <code>read_tif()</code> command provided by the <code>ijtiff</code> package. We’ll assign it to a variable called <code>my_img</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"2ch100frame.tif"</span>, package <span class="op">=</span> <span class="st">"detrendr"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "/Users/runner/work/_temp/Library/detrendr/extdata/2ch100frame.tif"</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_img</span> <span class="op">&lt;-</span> <span class="fu">read_tif</span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Reading 2ch100frame.tif: an 8-bit, 30x28 pixel image of</span></span>
<span><span class="co">#&gt; unsigned integer type. Reading 2 channels and 100 frames . . .</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Done.</span></span></code></pre>
<p><code>my_img</code> is now a 4-dimensional array. Slots 1 and 2 hold the <code>y</code> and <code>x</code> pixel positions, slot 3 indexes the channel and slot 4 indexes the frame.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">my_img</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1]  30  28   2 100</span></span></code></pre>
<p>Plotting the mean intensities of the frames in the two channels, we can see that the second channel has more obvious bleaching.</p>
<pre><code><span><span class="co">#&gt; Warning: Removed 1 rows containing non-finite values (`stat_smooth()`).</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Warning: Removed 1 rows containing missing values (`geom_point()`).</span></span></code></pre>
<p><img src="single-images_files/figure-html/plot-mean-profile-1.png" width="672"></p>
<p>However, notice that channel 2 bleaches from 29 to 27 which is approximately 7%. That’s not much, so little correction will be necessary. This is good, you should always endeavour to keep bleaching below 20% and bleaching correction (detrending) should be viewed as a necessary evil.</p>
<p>The mean intensity of channel 1 is 0.81 and the mean intensity of channel 2 is 25.13. Let’s view the mean intensity images of channels 1 and 2.</p>
<pre><code><span><span class="co">#&gt; Using basic display functionality.</span></span>
<span><span class="co">#&gt;   * For better display functionality, install the EBImage package.</span></span>
<span><span class="co">#&gt;   * To install `EBImage`:</span></span>
<span><span class="co">#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.</span></span>
<span><span class="co">#&gt;     - Then run `BiocManager::install("EBImage")`.</span></span>
<span><span class="co">#&gt; Using basic display functionality.</span></span>
<span><span class="co">#&gt;   * For better display functionality, install the EBImage package.</span></span>
<span><span class="co">#&gt;   * To install `EBImage`:</span></span>
<span><span class="co">#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.</span></span>
<span><span class="co">#&gt;     - Then run `BiocManager::install("EBImage")`.</span></span></code></pre>
<p><img src="single-images_files/figure-html/display-mean-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="thresholding">Thresholding<a class="anchor" aria-label="anchor" href="#thresholding"></a>
</h2>
<p>You can see here that this is an image of part of a cell, with the edge of the cell across the top left and hence the top left corner of the image is not cell, just background. It’s important to <em>threshold</em> away this background part: the detrending routine assumes that all parts of the image are part of the region of interest (the cell), so we need to set the background parts to <code>NA</code> beforehand to tell the detrending routine that this area should be excluded. <code>detrendr</code> has all of the thresholding functionality of the <em>ImageJ Auto Threshold</em> plugin. You can read more about this at <a href="https://imagej.net/Auto_Threshold" class="external-link uri">https://imagej.net/Auto_Threshold</a>. My favourite method is <em>Huang</em>. Let’s look at both of these channels with <em>Huang</em> thresholding.</p>
<pre><code><span><span class="co">#&gt; Using basic display functionality.</span></span>
<span><span class="co">#&gt;   * For better display functionality, install the EBImage package.</span></span>
<span><span class="co">#&gt;   * To install `EBImage`:</span></span>
<span><span class="co">#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.</span></span>
<span><span class="co">#&gt;     - Then run `BiocManager::install("EBImage")`.</span></span>
<span><span class="co">#&gt; Using basic display functionality.</span></span>
<span><span class="co">#&gt;   * For better display functionality, install the EBImage package.</span></span>
<span><span class="co">#&gt;   * To install `EBImage`:</span></span>
<span><span class="co">#&gt;     - Install `BiocManager` with `install.packages("BiocManager")`.</span></span>
<span><span class="co">#&gt;     - Then run `BiocManager::install("EBImage")`.</span></span></code></pre>
<p><img src="single-images_files/figure-html/display-thresholded-mean-1.png" width="672"></p>
<p>That seems to have worked: the background region in the top left is now greyed out, indicating that it has been set to <code>NA</code>. <em>Huang</em> thresholding can be slow, so if you want something similar but faster, try <em>Triangle</em>. Always check that your thresholding <em>looks right</em> afterwards.</p>
<p>Thresholding of images is done with the <code>autothresholdr</code> package. Thresholding of a stack is preformed with <code>mean_stack_thresh()</code> which thresholds away pixels in the stack whose mean intensity is less than a certain threshold value.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_img_threshed</span> <span class="op">&lt;-</span> <span class="fu">autothresholdr</span><span class="fu">::</span><span class="fu"><a href="https://rorynolan.github.io/autothresholdr/reference/mean_stack_thresh.html" class="external-link">mean_stack_thresh</a></span><span class="op">(</span><span class="va">my_img</span>, <span class="st">"Huang"</span><span class="op">)</span></span></code></pre></div>
<p>Note that if all of the image is of interest, thresholding is not necessary and should not be done.</p>
</div>
<div class="section level2">
<h2 id="detrending">Detrending<a class="anchor" aria-label="anchor" href="#detrending"></a>
</h2>
<p>The best detrending method is <em>Robin Hood</em>, so I’ll be using that here. Other detrending methods provided in this package are there for legacy reasons.</p>
<p>To detrend the above thresholded with the <em>Robin Hood</em> algorithm, run</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_detrended_img</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detrending.html">img_detrend_robinhood</a></span><span class="op">(</span><span class="va">my_img_threshed</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check out the mean intensity profiles of this detrended image.</p>
<p><img src="single-images_files/figure-html/plot-detrended-mean-profile-1.png" width="672"></p>
<p>These mean intensity profiles neatly show that the image series has been detrended. Beware, however, that these mean intensity profiles are not a great way to compare detrending routines. There is the temptation to say whichever detrending routine finishes with the flattest mean intensity profile is the best, but this is not true because it is possible to over-detrend (which will over-flatten the mean intensity profile). More rigorous procedures are needed to compare detrending routines, for example using images with simulated photobleaching or other trend-inducing phenomena introduced.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rory Nolan.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
